---
title: "Getting Started with the `controlcharts` package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with the `controlcharts` package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Workaround for crosstalk bug which needs 'filter_slider' to be first HTML element when working with dates
# Simply create a hidden/'dummy' filter to initialise correct includes
# https://github.com/rstudio/crosstalk/issues/65
crosstalk::filter_slider("dummy", "dummy", crosstalk::SharedData$new(data.frame(d = as.Date("01/01/1970"))), ~d)
```

## Generate Data

```{r}
library(controlcharts)

set.seed(12324)

dat <- do.call(
  rbind.data.frame,
  lapply(toupper(letters[1:10]), function(grp) {
    denom <- sample(0:100, 24)
    data.frame(
      country = sample(c("C1", "C2", "C3"), 1, replace = TRUE),
      organisation = grp,
      month_start = seq(as.Date('2024-01-01'), length.out=24, by="month"),
      numerators = rbinom(n = 24, size = denom, prob = 0.3),
      denominators = denom
    )
  })
)
DT::datatable(dat)
```

## SPC

### Create Plot

```{r}
spc_plt <- controlcharts::spc(data = dat,
                              keys = month_start,
                              numerators = numerators,
                              denominators = denominators,
                              scatter_settings = list(size = 4),
                              outlier_settings = list(astronomical = TRUE,
                                                      shift = TRUE,
                                                      shift_n = 4,
                                                      two_in_three = TRUE),
                              nhs_icon_settings = list(show_variation_icons = TRUE),
                              width = 640, height = 480)
```

### Interactive

```{r}
spc_plt$html_plot
```

### Static

```{r, eval=FALSE}
spc_plt$static_plot
```


```{r, echo=FALSE, out.width=640}
spc_plt$save_plot("spc.png", width = 640, height = 480)
knitr::include_graphics("spc.png")
```

### Control Limits

```{r}
DT::datatable(spc_plt$limits) |>
  DT::formatRound(c("value", "target", "ll99", "ll95", "ll68", "ul68", "ul95", "ul99"))
```

## Funnel

### Create Plot

```{r}
fun_plt <- controlcharts::funnel(data = dat,
                                 keys = organisation,
                                 numerators = numerators,
                                 denominators=denominators,
                                 scatter_settings = list(size = 4),
                                 y_axis_settings = list(ylimit_u = 100),
                              width = 640, height = 480)
```

### Interactive

```{r}
fun_plt$html_plot
```

### Static

```{r, eval=FALSE}
fun_plt$static_plot
```


```{r, echo=FALSE, out.width=640}
fun_plt$save_plot("funnel.png", width = 640, height = 480)
knitr::include_graphics("funnel.png")
```

### Control Limits

```{r}
DT::datatable(fun_plt$limits) |>
  DT::formatRound(c("value", "target", "ll99", "ll95", "ll68", "ul68", "ul95", "ul99"))
```

## Crosstalk

```{r}
crosstalk_dat <- crosstalk::SharedData$new(dat)
spc_plt <- controlcharts::spc(data = crosstalk_dat,
                              keys = month_start,
                              numerators = numerators,
                              denominators = denominators,
                              scatter_settings = list(size = 4),
                              outlier_settings = list(astronomical = TRUE,
                                                      shift = TRUE,
                                                      shift_n = 4,
                                                      two_in_three = TRUE),
                              nhs_icon_settings = list(show_variation_icons = TRUE))
fun_plt <- controlcharts::funnel(data = crosstalk_dat,
                                 keys = organisation,
                                 numerators = numerators,
                                 denominators=denominators,
                                 scatter_settings = list(size = 4),
                                 y_axis_settings = list(ylimit_u = 100))
```

```{r, eval=FALSE}
country_filter <- crosstalk::filter_select("countryFilter", "Country",
                                             crosstalk_dat, ~country)
org_filter <- crosstalk::filter_select("orgFilter", "Organisation",
                                         crosstalk_dat, ~organisation)
date_filter <- crosstalk::filter_slider("monthFilter", "Date",
                                        crosstalk_dat, ~month_start)
crosstalk::bscols(
  date_filter,
  org_filter,
  country_filter
)
crosstalk::bscols(
  fun_plt$html_plot,
  spc_plt$html_plot
)
```

```{r, echo=FALSE}
country_filter <- crosstalk::filter_select("countryFilter", "Country",
                                             crosstalk_dat, ~country)
org_filter <- crosstalk::filter_select("orgFilter", "Organisation",
                                         crosstalk_dat, ~organisation)
date_filter <- crosstalk::filter_slider("monthFilter", "Date",
                                        crosstalk_dat, ~month_start)
crosstalk::bscols(date_filter, country_filter, org_filter)
```

```{r, echo=FALSE}
crosstalk::bscols(
  fun_plt$html_plot,
  spc_plt$html_plot
)
```
